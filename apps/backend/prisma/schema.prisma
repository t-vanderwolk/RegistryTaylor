generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  MEMBER
  MENTOR
  ADMIN
}

enum RegistrySource {
  macro
  silvercross
  awin
  cj
  myregistry
  babylist
  impact
  static
}

enum RsvpStatus {
  GOING
  INTERESTED
  DECLINED
}

model User {
  id             String            @id @default(uuid())
  email          String            @unique
  passwordHash   String
  role           UserRole          @default(MEMBER)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  profile        Profile?
  questionnaire  Questionnaire?
  academyProgress AcademyProgress[]
  registryItems   RegistryItem[]
  mentorNotes     RegistryNote[]    @relation("MentorNotes")
  communityPosts CommunityPost[]
  eventsCreated  Event[]           @relation("EventCreators")
  workbookEntries WorkbookEntry[]
  eventRsvps     EventRsvp[]
  menteeProfiles Profile[]         @relation("ProfileMentor")
}

model Profile {
  id                String   @id @default(uuid())
  userId            String   @unique
  mentorId          String?
  conciergePriority Int?
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user   User @relation(fields: [userId], references: [id])
  mentor User? @relation("ProfileMentor", fields: [mentorId], references: [id])

  @@index([mentorId])
}

model Questionnaire {
  id            String   @id @default(uuid())
  userId        String   @unique
  dueDate       DateTime?
  availability  String?
  birthLocation String?
  supportNeeds  String?
  preferences   Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model AcademyModule {
  id             String            @id @default(cuid())
  title          String
  slug           String            @unique
  category       String   @default("")
  summary        String   @default("")
  lecture        String   @default("")
  workbookPrompt String   @default("")
  order          Int      @default(0)
  content        Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  progress       AcademyProgress[]
  workbookEntries WorkbookEntry[]
}

model AcademyProgress {
  id        String   @id @default(uuid())
  userId    String
  moduleId  String
  percent   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User          @relation(fields: [userId], references: [id])
  module AcademyModule @relation(fields: [moduleId], references: [id])

  @@unique([userId, moduleId])
}

model RegistryItem {
  id            String         @id @default(uuid())
  userId        String
  name          String
  brand         String?
  category      String?
  price         Decimal?       @db.Decimal(10, 2)
  imageUrl      String?
  url           String?
  retailer      String?
  notes         String?
  source        RegistrySource @default(myregistry)
  affiliateUrl  String?
  affiliateId   String?
  externalId    String
  importedFrom  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentorNotes  RegistryNote[]

  @@unique([externalId, userId])
}

model CommunityPost {
  id        String   @id @default(uuid())
  authorId  String
  title     String
  body      String
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id])
}

model RegistryNote {
  id             String   @id @default(uuid())
  registryItemId String
  mentorId       String?
  content        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  registryItem RegistryItem @relation(fields: [registryItemId], references: [id], onDelete: Cascade)
  mentor       User?        @relation("MentorNotes", fields: [mentorId], references: [id], onDelete: SetNull)

  @@unique([registryItemId, mentorId])
}

model RegistryCatalogItem {
  id           String         @id @default(uuid())
  externalId   String?
  title        String
  brand        String?
  retailer     String?
  category     String?
  price        Decimal?       @db.Decimal(10, 2)
  image        String?
  url          String?
  affiliateUrl String?
  source       RegistrySource @default(myregistry)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Event {
  id          String   @id @default(uuid())
  createdById String
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime?
  location    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User      @relation("EventCreators", fields: [createdById], references: [id])
  rsvps     EventRsvp[]
}

model EventRsvp {
  id        String     @id @default(uuid())
  eventId   String
  userId    String
  status    RsvpStatus @default(GOING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  event Event @relation(fields: [eventId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
}

model BlogPost {
  id          String   @id @default(uuid())
  slug        String   @unique
  title       String
  excerpt     String?
  body        String
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WorkbookEntry {
  id         String   @id @default(uuid())
  memberId   String
  moduleSlug String
  content    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  member User          @relation(fields: [memberId], references: [id])
  module AcademyModule @relation(fields: [moduleSlug], references: [slug])

  @@unique([memberId, moduleSlug])
}
