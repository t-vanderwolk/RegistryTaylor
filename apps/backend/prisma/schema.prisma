generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(uuid())
  email           String            @unique
  passwordHash    String
  role            UserRole          @default(MEMBER)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  academyProgress AcademyProgress[]
  communityPosts  CommunityPost[]
  eventsCreated   Event[]           @relation("EventCreators")
  eventRsvps      EventRsvp[]
  menteeProfiles  Profile[]         @relation("ProfileMentor")
  profile         Profile?
  questionnaire   Questionnaire?
  registryItems   RegistryItem[]
  mentorNotes     RegistryNote[]    @relation("MentorNotes")
  workbookEntries WorkbookEntry[]
  announcements   Announcement[]
  comments        Comment[]
  sentMessages    Message[]         @relation("SentMessages")
  receivedMessages Message[]        @relation("ReceivedMessages")
}

model Profile {
  id                String   @id @default(uuid())
  userId            String   @unique
  mentorId          String?
  conciergePriority Int?
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  mentor            User?    @relation("ProfileMentor", fields: [mentorId], references: [id])
  user              User     @relation(fields: [userId], references: [id])

  @@index([mentorId])
}

model Questionnaire {
  id            String    @id @default(uuid())
  userId        String    @unique
  dueDate       DateTime?
  availability  String?
  birthLocation String?
  supportNeeds  String?
  preferences   Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id])
}

model AcademyModule {
  id              String            @id @default(cuid())
  title           String
  slug            String            @unique
  content         Json?
  summary         String            @default("")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  category        String            @default("")
  lecture         String            @default("")
  order           Int               @default(0)
  workbookPrompt  String            @default("")
  progress        AcademyProgress[]
  workbookEntries WorkbookEntry[]
}

model AcademyProgress {
  id        String        @id @default(uuid())
  userId    String
  moduleId  String
  percent   Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  module    AcademyModule @relation(fields: [moduleId], references: [id])
  user      User          @relation(fields: [userId], references: [id])

  @@unique([userId, moduleId])
}

model RegistryItem {
  id           String         @id @default(uuid())
  name         String
  brand        String?
  category     String?
  price        Decimal?       @db.Decimal(10, 2)
  url          String?
  source       RegistrySource @default(myregistry)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  affiliateId  String?
  affiliateUrl String?
  externalId   String
  imageUrl     String?
  importedFrom String?
  notes        String?
  retailer     String?
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentorNotes  RegistryNote[]

  @@unique([externalId, userId])
}

model CommunityPost {
  id        String   @id @default(uuid())
  authorId  String
  title     String
  body      String
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id])
  comments  Comment[]
}

model RegistryNote {
  id             String       @id @default(uuid())
  registryItemId String
  mentorId       String?
  content        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  mentor         User?        @relation("MentorNotes", fields: [mentorId], references: [id])
  registryItem   RegistryItem @relation(fields: [registryItemId], references: [id], onDelete: Cascade)

  @@unique([registryItemId, mentorId])
}

model RegistryCatalogItem {
  id           String         @id @default(uuid())
  externalId   String?
  title        String
  brand        String?
  retailer     String?
  category     String?
  price        Decimal?       @db.Decimal(10, 2)
  image        String?
  url          String?
  affiliateUrl String?
  source       RegistrySource @default(myregistry)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Event {
  id          String      @id @default(uuid())
  createdById String
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime?
  location    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdBy   User        @relation("EventCreators", fields: [createdById], references: [id])
  rsvps       EventRsvp[]
}

model EventRsvp {
  id        String     @id @default(uuid())
  eventId   String
  userId    String
  status    RsvpStatus @default(GOING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  event     Event      @relation(fields: [eventId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
}

model BlogPost {
  id          String   @id @default(uuid())
  slug        String   @unique
  title       String
  excerpt     String?
  body        String
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WorkbookEntry {
  id         String        @id @default(uuid())
  memberId   String
  moduleSlug String
  content    Json
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  member     User          @relation(fields: [memberId], references: [id])
  module     AcademyModule @relation(fields: [moduleSlug], references: [slug])

  @@unique([memberId, moduleSlug])
}

model Announcement {
  id        String   @id @default(uuid())
  authorId  String
  title     String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post   CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User          @relation(fields: [authorId], references: [id])

  @@index([postId])
}

model Poll {
  id        String   @id @default(uuid())
  question  String
  category  String
  isActive  Boolean  @default(true)
  closesAt  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  options PollOption[]
}

model PollOption {
  id     String @id @default(uuid())
  pollId String
  label  String
  votes  Int    @default(0)
  order  Int    @default(0)

  poll Poll @relation(fields: [pollId], references: [id], onDelete: Cascade)

  @@index([pollId])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  content    String
  createdAt  DateTime @default(now())
  read       Boolean  @default(false)

  sender   User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

enum UserRole {
  MEMBER
  MENTOR
  ADMIN
}

enum RegistrySource {
  macro
  silvercross
  awin
  cj
  myregistry
  babylist
  impact
  static
}

enum RsvpStatus {
  GOING
  INTERESTED
  DECLINED
}
